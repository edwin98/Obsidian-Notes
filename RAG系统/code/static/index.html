<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RAG Demo</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:         #0d1117;
      --surface:    #161b22;
      --surface2:   #21262d;
      --border:     #30363d;
      --text:       #e6edf3;
      --muted:      #8b949e;
      --accent:     #58a6ff;
      --user-bg:    #1f6feb;
      --green:      #3fb950;
      --red:        #f85149;
      --orange:     #f0883e;
      --radius:     10px;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      height: 100dvh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* â”€â”€ Header â”€â”€ */
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      height: 52px;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-icon {
      width: 28px;
      height: 28px;
      border-radius: 6px;
      background: linear-gradient(135deg, var(--accent), #a371f7);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 700;
      color: #fff;
    }

    .logo-text {
      font-size: 14px;
      font-weight: 600;
    }

    .logo-sub {
      font-size: 11px;
      color: var(--muted);
      margin-top: 1px;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .status-pill {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 11px;
      color: var(--muted);
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 3px 10px;
    }

    .status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--green);
      transition: background 0.3s;
    }
    .status-dot.connecting { background: var(--orange); }
    .status-dot.error      { background: var(--red); }

    .new-chat-btn {
      background: none;
      border: 1px solid var(--border);
      color: var(--muted);
      border-radius: 6px;
      padding: 4px 10px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.15s;
    }
    .new-chat-btn:hover { border-color: var(--accent); color: var(--accent); }

    /* â”€â”€ Messages â”€â”€ */
    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 24px 20px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      scrollbar-width: thin;
      scrollbar-color: var(--border) transparent;
    }
    #messages::-webkit-scrollbar       { width: 5px; }
    #messages::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

    /* â”€â”€ Welcome screen â”€â”€ */
    .welcome {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      gap: 12px;
      padding: 40px 20px;
      animation: fadeUp 0.4s ease;
    }

    .welcome-icon {
      font-size: 40px;
      line-height: 1;
      filter: grayscale(0.2);
    }

    .welcome h2 {
      font-size: 20px;
      font-weight: 600;
    }

    .welcome p {
      font-size: 13px;
      color: var(--muted);
      line-height: 1.7;
      max-width: 380px;
    }

    .examples {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
      margin-top: 8px;
    }

    .example-chip {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 6px 14px;
      font-size: 12px;
      color: var(--muted);
      cursor: pointer;
      transition: all 0.15s;
    }
    .example-chip:hover { border-color: var(--accent); color: var(--accent); }

    /* â”€â”€ Message row â”€â”€ */
    .msg-row {
      display: flex;
      gap: 10px;
      animation: fadeUp 0.2s ease;
    }

    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(10px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .msg-row.user     { flex-direction: row-reverse; }
    .msg-row.user .bubble { background: var(--user-bg); color: #fff; border-radius: 14px 4px 14px 14px; }
    .msg-row.assistant .bubble { background: var(--surface); border: 1px solid var(--border); border-radius: 4px 14px 14px 14px; }

    .avatar {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 700;
      flex-shrink: 0;
      margin-top: 2px;
    }

    .msg-row.user .avatar {
      background: var(--user-bg);
      color: #fff;
    }

    .msg-row.assistant .avatar {
      background: var(--surface2);
      color: var(--accent);
      border: 1px solid var(--border);
    }

    .msg-body { display: flex; flex-direction: column; gap: 6px; max-width: min(72%, 700px); }

    .bubble {
      padding: 10px 14px;
      font-size: 14px;
      line-height: 1.65;
      word-break: break-word;
    }

    /* â”€â”€ Markdown inside bubble â”€â”€ */
    .bubble p          { margin-bottom: 8px; }
    .bubble p:last-child { margin-bottom: 0; }
    .bubble h1, .bubble h2, .bubble h3 { margin: 12px 0 6px; font-size: 1em; font-weight: 600; }
    .bubble ul, .bubble ol { padding-left: 18px; margin: 6px 0; }
    .bubble li         { margin-bottom: 3px; }
    .bubble code {
      background: rgba(0,0,0,0.35);
      padding: 1px 5px;
      border-radius: 4px;
      font-family: "Cascadia Code", "Fira Code", Consolas, monospace;
      font-size: 13px;
      color: var(--orange);
    }
    .bubble pre {
      background: #010409;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 14px;
      overflow-x: auto;
      margin: 8px 0;
    }
    .bubble pre code { background: none; padding: 0; color: var(--text); }
    .bubble blockquote {
      border-left: 3px solid var(--accent);
      padding-left: 10px;
      margin: 8px 0;
      color: var(--muted);
    }
    .bubble strong { color: var(--accent); }
    .bubble a      { color: var(--accent); }
    .bubble table  { border-collapse: collapse; width: 100%; margin: 8px 0; font-size: 13px; }
    .bubble th, .bubble td { border: 1px solid var(--border); padding: 6px 10px; text-align: left; }
    .bubble th { background: var(--surface2); }

    /* â”€â”€ Cursor blink â”€â”€ */
    .cursor {
      display: inline-block;
      width: 2px;
      height: 1em;
      background: var(--text);
      vertical-align: text-bottom;
      margin-left: 1px;
      animation: blink 0.85s step-end infinite;
    }
    @keyframes blink { 50% { opacity: 0; } }

    /* â”€â”€ Meta info (source badge, citations) â”€â”€ */
    .msg-meta { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }

    .badge {
      font-size: 10px;
      font-weight: 600;
      padding: 2px 7px;
      border-radius: 4px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }
    .badge.rag   { background: #1a2e4a; color: var(--accent); }
    .badge.cache { background: #1a3326; color: var(--green); }

    .cite-toggle {
      background: none;
      border: 1px solid var(--border);
      color: var(--muted);
      border-radius: 4px;
      padding: 2px 8px;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.15s;
    }
    .cite-toggle:hover { border-color: var(--accent); color: var(--accent); }

    .cite-list {
      display: none;
      font-size: 11px;
      color: var(--muted);
      font-family: Consolas, monospace;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 8px 10px;
      line-height: 1.8;
    }
    .cite-list.open { display: block; }

    /* â”€â”€ Input area â”€â”€ */
    #input-area {
      padding: 12px 20px 16px;
      border-top: 1px solid var(--border);
      background: var(--surface);
      flex-shrink: 0;
    }

    .input-row {
      display: flex;
      gap: 10px;
      align-items: flex-end;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 8px 8px 8px 14px;
      transition: border-color 0.15s;
    }
    .input-row:focus-within { border-color: var(--accent); }

    #query-input {
      flex: 1;
      background: none;
      border: none;
      outline: none;
      color: var(--text);
      font-size: 14px;
      line-height: 1.5;
      resize: none;
      min-height: 24px;
      max-height: 160px;
      font-family: inherit;
    }
    #query-input::placeholder { color: var(--muted); }

    #send-btn {
      background: var(--accent);
      border: none;
      border-radius: 7px;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      flex-shrink: 0;
      transition: opacity 0.15s, transform 0.1s;
    }
    #send-btn:hover:not(:disabled) { opacity: 0.85; }
    #send-btn:active:not(:disabled) { transform: scale(0.94); }
    #send-btn:disabled { opacity: 0.35; cursor: not-allowed; }

    #send-btn svg { width: 16px; height: 16px; fill: #0d1117; }

    .input-hint {
      font-size: 11px;
      color: var(--muted);
      margin-top: 6px;
      padding-left: 2px;
    }
  </style>
</head>
<body>

<header>
  <div class="logo">
    <div class="logo-icon">R</div>
    <div>
      <div class="logo-text">RAG Demo System</div>
      <div class="logo-sub">ä¸‰çº§æ··åˆæ£€ç´¢ Â· BM25 + å‘é‡ + Rerank</div>
    </div>
  </div>
  <div class="header-right">
    <div class="status-pill">
      <div class="status-dot connecting" id="status-dot"></div>
      <span id="status-text">è¿æ¥ä¸­...</span>
    </div>
    <button class="new-chat-btn" onclick="newChat()">æ–°å¯¹è¯</button>
  </div>
</header>

<div id="messages">
  <div class="welcome" id="welcome">
    <div class="welcome-icon">ğŸ”</div>
    <h2>æ¬¢è¿ä½¿ç”¨ RAG Demo</h2>
    <p>åŸºäºä¸‰çº§æ¸è¿›å¼æ··åˆæ£€ç´¢çš„æ™ºèƒ½é—®ç­”ç³»ç»Ÿ<br>æ”¯æŒ SSE æµå¼è¾“å‡ºï¼Œå†…ç½® 5G/æ— çº¿é€šä¿¡é¢†åŸŸç¤ºä¾‹æ–‡æ¡£</p>
    <div class="examples">
      <span class="example-chip" onclick="fillAndSend(this.textContent)">5G NR éšæœºæ¥å…¥æµç¨‹æ˜¯ä»€ä¹ˆï¼Ÿ</span>
      <span class="example-chip" onclick="fillAndSend(this.textContent)">PRACH ä¿¡é“çš„ä½œç”¨</span>
      <span class="example-chip" onclick="fillAndSend(this.textContent)">MIMO æ³¢æŸèµ‹å½¢åŸç†</span>
      <span class="example-chip" onclick="fillAndSend(this.textContent)">RAG ç³»ç»Ÿçš„ä¸‰çº§æ£€ç´¢æµç¨‹</span>
      <span class="example-chip" onclick="fillAndSend(this.textContent)">Transformer æ³¨æ„åŠ›æœºåˆ¶</span>
    </div>
  </div>
</div>

<div id="input-area">
  <div class="input-row">
    <textarea id="query-input" placeholder="è¾“å…¥é—®é¢˜... ï¼ˆEnter å‘é€ï¼ŒShift+Enter æ¢è¡Œï¼‰" rows="1"></textarea>
    <button id="send-btn" onclick="sendMessage()" title="å‘é€">
      <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
      </svg>
    </button>
  </div>
  <div class="input-hint">ä¼šè¯ ID: <span id="session-display">â€”</span></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/marked@9/marked.min.js"></script>
<script>
// â”€â”€ é…ç½® â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const USER_ID = "demo_user";
let SESSION_ID = newSessionId();

marked.use({ breaks: true, gfm: true });

// â”€â”€ åˆå§‹åŒ– â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById("session-display").textContent = SESSION_ID;
checkHealth();

// â”€â”€ è¾“å…¥æ¡†è‡ªé€‚åº”é«˜åº¦ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const inputEl = document.getElementById("query-input");
inputEl.addEventListener("input", () => {
  inputEl.style.height = "auto";
  inputEl.style.height = Math.min(inputEl.scrollHeight, 160) + "px";
});

inputEl.addEventListener("keydown", (e) => {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});

// â”€â”€ å·¥å…·å‡½æ•° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function newSessionId() {
  return "sess_" + Math.random().toString(36).slice(2, 10);
}

function scrollToBottom() {
  const msgs = document.getElementById("messages");
  msgs.scrollTop = msgs.scrollHeight;
}

function fillAndSend(text) {
  inputEl.value = text;
  sendMessage();
}

function newChat() {
  SESSION_ID = newSessionId();
  document.getElementById("session-display").textContent = SESSION_ID;

  const msgs = document.getElementById("messages");
  msgs.innerHTML = `
    <div class="welcome" id="welcome">
      <div class="welcome-icon">ğŸ”</div>
      <h2>æ–°å¯¹è¯å·²å¼€å§‹</h2>
      <p>ä¼šè¯ ID å·²é‡ç½®ï¼Œå†å²ä¸Šä¸‹æ–‡å·²æ¸…ç©ºã€‚</p>
    </div>`;
}

// â”€â”€ å¥åº·æ£€æŸ¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function checkHealth() {
  const dot  = document.getElementById("status-dot");
  const text = document.getElementById("status-text");

  dot.className = "status-dot connecting";
  text.textContent = "è¿æ¥ä¸­...";

  try {
    const res  = await fetch("/health");
    const data = await res.json();
    dot.className = "status-dot";
    text.textContent = `å°±ç»ª Â· ${data.chunks_indexed} å—`;
  } catch {
    dot.className = "status-dot error";
    text.textContent = "æœåŠ¡æœªå°±ç»ª";
  }
}

// â”€â”€ æ·»åŠ ç”¨æˆ·æ¶ˆæ¯ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addUserMessage(text) {
  removeWelcome();
  const row = document.createElement("div");
  row.className = "msg-row user";
  row.innerHTML = `
    <div class="avatar">U</div>
    <div class="msg-body">
      <div class="bubble">${escapeHtml(text)}</div>
    </div>`;
  document.getElementById("messages").appendChild(row);
  scrollToBottom();
}

// â”€â”€ æ·»åŠ  AI æ¶ˆæ¯å ä½ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addAssistantPlaceholder() {
  const row = document.createElement("div");
  row.className = "msg-row assistant";

  const bubble = document.createElement("div");
  bubble.className = "bubble";

  const textSpan = document.createElement("span");
  textSpan.className = "stream-text";

  const cursor = document.createElement("span");
  cursor.className = "cursor";

  bubble.appendChild(textSpan);
  bubble.appendChild(cursor);

  const body = document.createElement("div");
  body.className = "msg-body";
  body.appendChild(bubble);

  row.appendChild(document.createElement("div")); // avatar placeholder
  row.children[0].className = "avatar";
  row.children[0].textContent = "AI";
  row.appendChild(body);

  document.getElementById("messages").appendChild(row);
  scrollToBottom();

  return { row, bubble, textSpan, cursor, body };
}

// â”€â”€ è¿½åŠ  token â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function appendToken(textSpan, token) {
  textSpan.textContent += token;
  scrollToBottom();
}

// â”€â”€ æµå¼å®Œæˆï¼Œæ¸²æŸ“ Markdown â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function finalizeAssistant({ bubble, textSpan, cursor, body }, source, citations) {
  const rawText = textSpan.textContent;
  cursor.remove();
  bubble.innerHTML = marked.parse(rawText || "ï¼ˆæ— è¾“å‡ºï¼‰");

  // source badge
  const isCache = source && source.includes("cache");
  const meta = document.createElement("div");
  meta.className = "msg-meta";

  const badge = document.createElement("span");
  badge.className = `badge ${isCache ? "cache" : "rag"}`;
  badge.textContent = isCache ? "Cache" : "RAG";
  meta.appendChild(badge);

  // citations
  if (citations && citations.length > 0) {
    const btn = document.createElement("button");
    btn.className = "cite-toggle";
    btn.textContent = `å¼•ç”¨ ${citations.length} å—`;

    const list = document.createElement("div");
    list.className = "cite-list";
    list.textContent = citations.join("\n");

    btn.onclick = () => list.classList.toggle("open");
    meta.appendChild(btn);
    body.appendChild(meta);
    body.appendChild(list);
  } else {
    body.appendChild(meta);
  }
}

// â”€â”€ ä¸»å‘é€é€»è¾‘ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let isStreaming = false;

async function sendMessage() {
  if (isStreaming) return;

  const query = inputEl.value.trim();
  if (!query) return;

  inputEl.value = "";
  inputEl.style.height = "auto";

  addUserMessage(query);
  const elements = addAssistantPlaceholder();

  isStreaming = true;
  document.getElementById("send-btn").disabled = true;

  try {
    const res = await fetch("/chat/stream", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        user_id:    USER_ID,
        session_id: SESSION_ID,
        query:      query,
        top_k:      10,
      }),
    });

    if (!res.ok) {
      throw new Error(`HTTP ${res.status}: ${res.statusText}`);
    }

    const reader  = res.body.getReader();
    const decoder = new TextDecoder();
    let buffer = "";
    let done   = false;

    while (!done) {
      const { done: streamDone, value } = await reader.read();
      if (streamDone) break;

      buffer += decoder.decode(value, { stream: true });

      // æŒ‰ SSE äº‹ä»¶è¾¹ç•Œï¼ˆ\n\nï¼‰åˆ†å‰²
      const events = buffer.split("\n\n");
      buffer = events.pop(); // æœ€åä¸€æ®µå¯èƒ½ä¸å®Œæ•´ï¼Œä¿ç•™

      for (const event of events) {
        for (const line of event.split("\n")) {
          if (!line.startsWith("data: ")) continue;
          const data = line.slice(6);
          if (data === "[DONE]") { done = true; break; }
          appendToken(elements.textSpan, data);
        }
        if (done) break;
      }
    }

    finalizeAssistant(elements, "rag", []);

  } catch (err) {
    elements.cursor.remove();
    elements.bubble.innerHTML =
      `<span style="color:var(--red)">è¯·æ±‚å¤±è´¥ï¼š${escapeHtml(err.message)}</span>`;
  } finally {
    isStreaming = false;
    document.getElementById("send-btn").disabled = false;
    inputEl.focus();
    checkHealth();
  }
}

// â”€â”€ è¾…åŠ© â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function removeWelcome() {
  const w = document.getElementById("welcome");
  if (w) w.remove();
}

function escapeHtml(str) {
  return str.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
}
</script>
</body>
</html>
